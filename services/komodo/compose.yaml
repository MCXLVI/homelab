services:
    postgres:
        image: ghcr.io/ferretdb/postgres-documentdb:${KOMODO_POSTGRES_IMAGE_TAG:-17-0.107.0-ferretdb-2.7.0}
        restart: unless-stopped
        labels:
            komodo.skip:
        secrets:
            - komodo_db_password
        environment:
            POSTGRES_USER: ${KOMODO_DB_USERNAME}
            POSTGRES_PASSWORD_FILE: /run/secrets/komodo_db_password
            POSTGRES_DB: postgres
        volumes:
            - postgres-data:/var/lib/postgresql/data
        networks:
            - komodo-internal

    ferretdb:
        image: ghcr.io/ferretdb/ferretdb:${KOMODO_FERRETDB_IMAGE_TAG:-2.7.0}
        restart: unless-stopped
        labels:
            komodo.skip:
        secrets:
            - komodo_db_url
        environment:
            FERRETDB_POSTGRESQL_URL_FILE: /run/secrets/komodo_db_url
        volumes:
            - ferretdb-state:/state
        depends_on:
            - postgres
        networks:
            - komodo-internal

    core:
        container_name: komodo-core
        image: ghcr.io/moghtech/komodo-core:${KOMODO_IMAGE_TAG:-latest}
        restart: unless-stopped
        labels:
            komodo.skip:
        secrets:
            - komodo_init_password
            - komodo_db_password
            - komodo_passkey
            - komodo_webhook_secret
            - komodo_jwt_secret
        environment:
            TZ: ${TZ}
            KOMODO_HOST: https://${KOMODO_DOMAIN}
            KOMODO_PORT: ${KOMODO_PORT}
            KOMODO_DISABLE_CONFIRM_DIALOG: true
            KOMODO_LOCAL_AUTH: true
            KOMODO_DISABLE_USER_REGISTRATION: true
            KOMODO_INIT_ADMIN_USERNAME: ${KOMODO_INIT_ADMIN_USERNAME}
            KOMODO_INIT_ADMIN_PASSWORD_FILE: /run/secrets/komodo_init_password
            KOMODO_DATABASE_ADDRESS: ferretdb:27017
            KOMODO_DATABASE_USERNAME: ${KOMODO_DB_USERNAME}
            KOMODO_DATABASE_PASSWORD_FILE: /run/secrets/komodo_db_password
            KOMODO_FIRST_SERVER: https://periphery:8120
            KOMODO_PASSKEY_FILE: /run/secrets/komodo_passkey
            KOMODO_WEBHOOK_SECRET_FILE: /run/secrets/komodo_webhook_secret
            KOMODO_JWT_SECRET_FILE: /run/secrets/komodo_jwt_secret
        volumes:
            - ${KOMODO_BACKUPS_PATH:-/etc/komodo/backups}:/backups
        depends_on:
            - ferretdb
        networks:
            - proxy-internal
            - komodo-internal
            - komodo-periphery

    periphery:
        image: ghcr.io/moghtech/komodo-periphery:${KOMODO_IMAGE_TAG:-latest}
        restart: unless-stopped
        labels:
            komodo.skip:
        secrets:
            - komodo_passkey
        environment:
            TZ: ${TZ}
            PERIPHERY_ROOT_DIRECTORY: ${KOMODO_ROOT_DIRECTORY:-/etc/komodo}
            PERIPHERY_PASSKEYS_FILE: /run/secrets/komodo_passkey
            PERIPHERY_INCLUDE_DISK_MOUNTS: /etc/hostname
        volumes:
            - ${KOMODO_ROOT_DIRECTORY:-/etc/komodo}:${KOMODO_ROOT_DIRECTORY:-/etc/komodo}
            - /var/run/docker.sock:/var/run/docker.sock:ro
            - /proc:/proc:ro
        networks:
            - komodo-periphery

secrets:
    komodo_init_password:
        environment: KOMODO_INIT_ADMIN_PASSWORD
    komodo_db_password:
        environment: KOMODO_DB_PASSWORD
    komodo_db_url:
        environment: KOMODO_DB_URL
    komodo_passkey:
        environment: KOMODO_PASSKEY
    komodo_webhook_secret:
        environment: KOMODO_WEBHOOK_SECRET
    komodo_jwt_secret:
        environment: KOMODO_JWT_SECRET

volumes:
    postgres-data:
    ferretdb-state:

networks:
    proxy-internal:
        external: true
    komodo-internal:
        internal: true
    komodo-periphery:
